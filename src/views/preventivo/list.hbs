<div class="container-fluid mb-5">
    <!-- id="cuerpo" -->
    <div class="row text-center my-2">
        <div class="col-lg-10 mx-auto">
            <h1>MANTENIMIENTOS PREVENTIVOS <i class="fa fa-ticket" aria-hidden="true"></i></h1>
            <div> <a class="btn btn-primary" href="/mantenimientopreventivo/add">Abrir Nuevo Preventivo</a></div>
        </div>
    </div>
    <div class="row mb-2">
        <div class=" col-lg-11 mx-auto">
            <div class="table-responsive">
                {{#if preventivos}}
                <div class="container-fluid my-3">
                    <div class="row align-items-end g-2">
                        <!-- Botón para mostrar solo resueltos -->
                        <div class="col-2">
                            <label for="filtroEstado" class="form-label fw-semibold text-light">Estado:</label>
                            <select id="filtroEstado" class="form-select form-select-sm">
                                <option value="">Todos</option>
                                <option value="pendiente">Activos</option>
                                <option value="resuelto">Cerrados</option>
                            </select>
                        </div>


                        <!-- Selector de usuario -->
                        <div class="col-3">
                            <label for="filtroCreador" class="form-label fw-semibold text-light">Filtrar por
                                usuario:</label>
                            <select id="filtroCreador" class="form-select form-select-sm">
                                <option value="">Todos los usuarios</option>
                                {{#each usuarios}}
                                <option value="{{this.usuario}}">{{this.usuario}}</option>
                                {{/each}}
                            </select>
                        </div>

                        <!-- Campo de búsqueda -->
                        <div class="col-3">
                            <label for="myInput" class="form-label fw-semibold text-light">Buscar:</label>
                            <input class="form-control form-control-sm" id="myInput" type="text"
                                placeholder="Filtrar por..." autofocus>
                        </div>
                        
                        <div class="col-3">
                            <button id="btnPrintSeleccion" class="btn btn-success">
                                Imprimir filtrado
                            </button>
                        </div>
                    </div>

                </div>

                <table data-search="true" id="listado" class="table table-sm table-dark rounded table-hover listado"
                    style="white-space: nowrap; overflow-x: auto;">
                    <tr class="info-color-dark">
                        <th>#</th>
                        <th>NIF</th>
                        <th>Fecha</th>
                        <th class="d-none d-md-table-cell">Creado por</th>
                        {{!-- <th class="d-none d-md-table-cell">Fecha inicio</th> --}}
                        <th class="d-none d-md-table-cell">Status</th>
                        <th>Accion</th>
                    </tr>

                    {{#each preventivos}}
                    <tr class="fila {{#if this.solved_at}}resuelto{{else}}pendiente{{/if}}"
                        data-creador="{{this.created_by}}">
                        <td>{{ this.preventivo_id }}</td>
                        <td> <a href="/aton/plantilla/{{ this.nif }} ">{{ this.nif }}</a> </td>
                        <td>{{formatearSp this.fecha}}</td>
                        <td class="d-none d-md-table-cell">{{ this.created_by }} </td>
                        {{!-- <td class="d-none d-md-table-cell">{{ timeagoSpCerrado this.created_at }} </td> --}}

                        {{#if this.solved_at}}
                        <td class="d-none d-md-table-cell">cerrado {{ timeagoSpCerrado this.solved_at }} por
                            {{this.solved_by}} </td>
                        {{else}}
                        <td class="d-none d-md-table-cell">activo {{timeagoSp this.created_at }} </td>
                        {{/if}}

                        <td>
                            {{#if this.solved_at}}
                            <a href="/mantenimientopreventivo/cerrado/{{this.preventivo_id}}" class="text-primary"><i
                                    class="fa fa-eye"></i>View</a>
                            <a href="/mantenimientopreventivo/cerrado/{{this.preventivo_id}}/pdf"
                                class="text-primary"><i class="fa fa-print"></i>Print</a>
                            {{else}}
                            <a href="/mantenimientopreventivo/edit/{{this.preventivo_id}}" class="text-primary"><i
                                    class="fa fa-pencil"></i>Edit</a>
                            <a type="submit" onclick='abreModalPrev({{this.preventivo_id}},{{ this.nif }})'
                                class=" text-primary"> <i class="fa fa-trash"></i>del</a>
                            {{/if}}

                        </td>
                    </tr>
                    {{/each}}
                    {{else}}
                    <p>No hay mantenimientos preventivos </p>
                    {{/if}}
                </table>
            </div>
        </div>
    </div>
</div>


<!-- Modal Procesando PDF -->
<div class="modal fade" id="modalProcesando" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content text-center">

            <div class="modal-body py-4">

                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Cargando...</span>
                </div>

                <h6 class="fw-semibold">Generando PDF</h6>
                <small class="text-muted">Por favor espere...</small>

            </div>

        </div>
    </div>
</div>

<script>
    const inputBusqueda = document.getElementById("myInput");
    const selectCreador = document.getElementById("filtroCreador");
    const selectEstado = document.getElementById("filtroEstado");
    const filas = document.querySelectorAll(".fila");

    function aplicarFiltros() {
        const texto = inputBusqueda.value.toLowerCase().trim();
        const creadorSeleccionado = selectCreador.value;
        const estadoSeleccionado = selectEstado.value;

        filas.forEach(fila => {
            const creador = fila.dataset.creador;
            const esResuelto = fila.classList.contains("resuelto");
            const estado = esResuelto ? "resuelto" : "pendiente";

            const textoFila = fila.innerText.toLowerCase();

            const cumpleTexto = !texto || textoFila.includes(texto);
            const cumpleCreador = !creadorSeleccionado || creador === creadorSeleccionado;
            const cumpleEstado = !estadoSeleccionado || estado === estadoSeleccionado;

            fila.style.display = (cumpleTexto && cumpleCreador && cumpleEstado)
                ? ""
                : "none";
        });
    }

    // Debounce para no ejecutar en cada tecla instantáneamente
    function debounce(func, delay = 300) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    inputBusqueda.addEventListener("keyup", debounce(aplicarFiltros));
    selectCreador.addEventListener("change", aplicarFiltros);
    selectEstado.addEventListener("change", aplicarFiltros);

    //Para seleccionar los items a imprimir en pdf
    document.getElementById("btnPrintSeleccion").addEventListener("click", async () => {

        const ids = [];

        document.querySelectorAll(".fila").forEach(fila => {
            if (fila.style.display !== "none") {
                const id = fila.children[0].innerText.trim();
                ids.push(id);
            }
        });

        if (!ids.length) {
            alert("No hay elementos seleccionados");
            return;
        }

        const modalElement = document.getElementById("modalProcesando");
        const modal = new bootstrap.Modal(modalElement);

        modal.show();

        try {

            const response = await fetch(
                `/mantenimientopreventivo/print-multiple?ids=${ids.join(",")}`
            );

            if (!response.ok) {
                throw new Error("Error generando PDF");
            }

            const blob = await response.blob();

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "preventivos-multiple.pdf";
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

        } catch (error) {
            alert("Error al generar el PDF");
            console.error(error);
        } finally {
            modal.hide();
        }
    });

</script>



{{>ModalBorradoPreventivo}}